import requests
import time

GRAPHQL_BATCHED_URL = "https://www.tripadvisor.com/data/graphql/batched"

def get_review_response(limit_num = 100, location_id = 14159911, offset = 100):
    
    payload = "[{\"query\":\"query ReviewListQuery($locationId: Int!, $offset: Int, $limit: Int, $filters: [FilterConditionInput!], $prefs: ReviewListPrefsInput, $initialPrefs: ReviewListPrefsInput, $filterCacheKey: String, $prefsCacheKey: String, $keywordVariant: String!, $needKeywords: Boolean = true) {\\n  cachedFilters: personalCache(key: $filterCacheKey)\\n  cachedPrefs: personalCache(key: $prefsCacheKey)\\n  locations(locationIds: [$locationId]) {\\n    locationId\\n    parentGeoId\\n    name\\n    placeType\\n    reviewSummary {\\n      rating\\n      count\\n    }\\n    keywords(variant: $keywordVariant) @include(if: $needKeywords) {\\n      keywords {\\n        keyword\\n      }\\n    }\\n    ... on LocationInformation {\\n      parentGeoId\\n    }\\n    ... on LocationInformation {\\n      parentGeoId\\n    }\\n    ... on LocationInformation {\\n      name\\n      currentUserOwnerStatus {\\n        isValid\\n      }\\n    }\\n    ... on LocationInformation {\\n      locationId\\n      currentUserOwnerStatus {\\n        isValid\\n      }\\n    }\\n    ... on LocationInformation {\\n      locationId\\n      parentGeoId\\n      accommodationCategory\\n      currentUserOwnerStatus {\\n        isValid\\n      }\\n      url\\n    }\\n    reviewListPage(page: {offset: $offset, limit: $limit}, filters: $filters, prefs: $prefs, initialPrefs: $initialPrefs, filterCacheKey: $filterCacheKey, prefsCacheKey: $prefsCacheKey) {\\n      totalCount\\n      preferredReviewIds\\n      reviews {\\n        ... on Review {\\n          id\\n          url\\n          location {\\n            locationId\\n            name\\n          }\\n          createdDate\\n          publishedDate\\n          provider {\\n            isLocalProvider\\n          }\\n          userProfile {\\n            id\\n            userId: id\\n            isMe\\n            isVerified\\n            displayName\\n            username\\n            avatar {\\n              id\\n              photoSizes {\\n                url\\n                width\\n                height\\n              }\\n            }\\n            hometown {\\n              locationId\\n              fallbackString\\n              location {\\n                locationId\\n                additionalNames {\\n                  long\\n                }\\n                name\\n              }\\n            }\\n            contributionCounts {\\n              sumAllUgc\\n              helpfulVote\\n            }\\n            route {\\n              url\\n            }\\n          }\\n        }\\n        ... on Review {\\n          title\\n          language\\n          url\\n        }\\n        ... on Review {\\n          language\\n          translationType\\n        }\\n        ... on Review {\\n          roomTip\\n        }\\n        ... on Review {\\n          tripInfo {\\n            stayDate\\n          }\\n          location {\\n            placeType\\n          }\\n        }\\n        ... on Review {\\n          additionalRatings {\\n            rating\\n            ratingLabel\\n          }\\n        }\\n        ... on Review {\\n          tripInfo {\\n            tripType\\n          }\\n        }\\n        ... on Review {\\n          language\\n          translationType\\n          mgmtResponse {\\n            id\\n            language\\n            translationType\\n          }\\n        }\\n        ... on Review {\\n          text\\n          publishedDate\\n          username\\n          connectionToSubject\\n          language\\n          mgmtResponse {\\n            id\\n            text\\n            language\\n            publishedDate\\n            username\\n            connectionToSubject\\n          }\\n        }\\n        ... on Review {\\n          id\\n          locationId\\n          title\\n          text\\n          rating\\n          absoluteUrl\\n          mcid\\n          translationType\\n          mtProviderId\\n          photos {\\n            id\\n            statuses\\n            photoSizes {\\n              url\\n              width\\n              height\\n            }\\n          }\\n          userProfile {\\n            id\\n            displayName\\n            username\\n          }\\n        }\\n        ... on Review {\\n          mgmtResponse {\\n            id\\n          }\\n          provider {\\n            isLocalProvider\\n          }\\n        }\\n        ... on Review {\\n          translationType\\n          location {\\n            locationId\\n            parentGeoId\\n          }\\n          provider {\\n            isLocalProvider\\n            isToolsProvider\\n          }\\n          original {\\n            id\\n            url\\n            locationId\\n            userId\\n            language\\n            submissionDomain\\n          }\\n        }\\n        ... on Review {\\n          locationId\\n          mcid\\n          attribution\\n        }\\n        ... on Review {\\n          __typename\\n          locationId\\n          helpfulVotes\\n          photoIds\\n          route {\\n            url\\n          }\\n          socialStatistics {\\n            followCount\\n            isFollowing\\n            isLiked\\n            isReposted\\n            isSaved\\n            likeCount\\n            repostCount\\n            tripCount\\n          }\\n          status\\n          userId\\n          userProfile {\\n            id\\n            displayName\\n            isFollowing\\n          }\\n          location {\\n            __typename\\n            locationId\\n            additionalNames {\\n              normal\\n              long\\n              longOnlyParent\\n              longParentAbbreviated\\n              longOnlyParentAbbreviated\\n              longParentStateAbbreviated\\n              longOnlyParentStateAbbreviated\\n              geo\\n              abbreviated\\n              abbreviatedRaw\\n              abbreviatedStateTerritory\\n              abbreviatedStateTerritoryRaw\\n            }\\n            parent {\\n              locationId\\n              additionalNames {\\n                normal\\n                long\\n                longOnlyParent\\n                longParentAbbreviated\\n                longOnlyParentAbbreviated\\n                longParentStateAbbreviated\\n                longOnlyParentStateAbbreviated\\n                geo\\n                abbreviated\\n                abbreviatedRaw\\n                abbreviatedStateTerritory\\n                abbreviatedStateTerritoryRaw\\n              }\\n            }\\n          }\\n        }\\n        ... on Review {\\n          text\\n          language\\n        }\\n        ... on Review {\\n          locationId\\n          absoluteUrl\\n          mcid\\n          translationType\\n          mtProviderId\\n          originalLanguage\\n          rating\\n        }\\n        ... on Review {\\n          id\\n          locationId\\n          title\\n          labels\\n          rating\\n          absoluteUrl\\n          mcid\\n          translationType\\n          mtProviderId\\n          alertStatus\\n        }\\n      }\\n    }\\n    reviewAggregations {\\n      ratingCounts\\n      languageCounts\\n      alertStatusCount\\n    }\\n  }\\n}\\n\",\"variables\":{\"locationId\":"+str(location_id)+",\"offset\":"+str(offset)+",\"filters\":[],\"prefs\":null,\"initialPrefs\":{},\"limit\":"+str(limit_num)+",\"filterCacheKey\":null,\"prefsCacheKey\":\"locationReviewPrefs\",\"needKeywords\":false,\"keywordVariant\":\"location_keywords_v2_llr_order_30_en\"}}]"

    headers = {
      'Host': 'www.tripadvisor.com',
      'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:76.0) Gecko/20100101 Firefox/76.0',
      'Accept': '*/*',
      'Accept-Language': 'en-US,en;q=0.5',
      'Accept-Encoding': 'gzip, deflate, br',
      'Content-Type': 'application/json',
      'Content-Length': str(len(payload)),
      'x-requested-by': 'TNI1625!AFBLriG9E9mRxHaBi32eBjKQ7a2LmfGAX+CVX2ohhCfmwzkaBi5IKROaZIk37QxcuQ1nkDBiBFJ8O0+QY9mSlFPJtOTv9drlx7Zhb8u/oaFKd+l2XQ4nWuhOi0LVR783Nj/vu5EnQHonT9aWaHIH0fhlqQpSI5m1jc4941UJKEal',
      'Origin': 'https://www.tripadvisor.com',
      'Referer': 'https://www.tripadvisor.com/Hotel_Review-g294197-d8522945-Reviews-or5-Lotte_City_Hotel_Myeongdong-Seoul.html',
      'Connection': 'keep-alive',
      'Cookie': 'TADCID=cOcqVDqiaJ3bfIQDABQCjnFE8vTET66GHuEzPi7KfV2daSzS8pP6rx4ql_j2cFTmf1NRiQzDk_kkPsXGHF6p9Z8BC5xSwP7l2cg; TAUnique=%1%enc%3AayfAkwbJJeeAwVmIfRXwAx40%2FJkRrjfstcGiVr%2B2u%2Bg%3D; __vt=KD3MTEFliJKd-gj7ABQCq4R_VSrMTACwWFvfTfL3vw17Cf9ZWlcXGMogFmspJGv0qRh0Uyq6QlL9RLrYrLHw8nkAW4vUFYd0VcSxSbwJ0iHWTj3RJb1sdR3MyXBO4YPKtVOfVzeZYVuzJyVhLD9BYSpY4Q; TASSK=enc%3AAOU72JpymfXV3H6FkRN13%2B5qBJZrJDzQ9p14k1ghDeq%2Fl4RaOAf15OhYRMO4icO4vqeJBMapnPl%2BkR7pCh1MD%2BTdIWnfO%2Fat9Mvyw6fAAqQuHW%2BhPcCKvFc%2FXWRz4zHM7Q%3D%3D; TASession=V2ID.C170A503FC1A4382340A9EA4D7BED189*SQ.8*LS.DemandLoadAjax*GR.3*TCPAR.15*TBR.91*EXEX.60*ABTR.39*PHTB.28*FS.91*CPU.82*HS.recommended*ES.popularity*DS.5*SAS.popularity*FPS.oldFirst*FA.1*DF.0*TRA.true*LD.8522945*EAU._; PAC=AGawaRoyF1vUheM3ExkUJbJQzrW9F3zPOE3apE_8yZxRZx6sSJDrggVrXQcIpkkWgC28Cs-WvlStRQlIzehpMs5ZiikTDErmtQuQV8uTJrQXPUquT0uwIpVW7LNjvj4eNA%3D%3D; SRT=%1%enc%3AgMFZiH0V8ANOML5gMl9nBRUU1qGRioH5iTz3sPDfwVjtrwWiOfbTnRSJsQq7ULbTNox8JbUSTxk%3D; ServerPool=C; PMC=V2*MS.95*MD.20200522*LD.20200522; TART=%1%enc%3AgMFZiH0V8ANOML5gMl9nBRUU1qGRioH5iTz3sPDfwVjtrwWiOfbTnRSJsQq7ULbTNox8JbUSTxk%3D; TATravelInfo=V2*AY.2020*AM.7*AD.29*DY.2020*DM.7*DD.30*A.2*MG.-1*HP.2*FL.3*DSM.1590122664468*RS.1; TAUD=LA-1590122651755-1*RDD-1-2020_05_22*HDD-12659-2020_07_29.2020_07_30.1*LD-23800-2020.7.29.2020.7.30*LG-23802-2.1.F.; ak_bmsc=B0E0E87BF5BA1B7C736FE40ECC3C2ACE173B488C5B4E00009A58C75E90F7027B~pl2K4Snt1sA5g2qpfTvheXiaPJOVCX0qOMZXCsAiZTWyglvi3+s+WAUkcVWnVyHQn+0Flfug5BGxhwSoRhvp5rnWrZ0qLTV+jCxdz3Ria0DCoUqzhDlWueC8fR5F3wrIqLMtNFXLeD0SmWZRecWVJ4A2T6Rqss0TxbL6AK7KxwpL4b/bzDvpxNazTkTN3Kc7kZhjSVmvU1bT3652bLm9ID2G6bMAoB1QGfUHvTwxmWBik=; bm_sv=B1BD7C505910AC866E774EE85EFAB727~pZKQtQu9yo4HfpMd+K4B6oYfV2TDQzQkdZLy6JdmPLur6+qygK1SAHLpGcljUK3aQruWBwvDCjg9rzIoy0tdQZW0oepLQi/QV4nOZNjj6KfSl/gC8TAHfyRKhnVzMRbJHW/Y57bFM+oUyiWtDb68lgNnIZ/5mV22ZOxj2cmeD2E=; TAReturnTo=%1%%2FHotel_Review-g294197-d8522945-Reviews-Lotte_City_Hotel_Myeongdong-Seoul.html; roybatty=TNI1625!ABq5yDRGlxK9TWRSVwV2gIkWYFdipPrDGJKuFt9lusHPCm5wsBxWAVSL7tzOY8MT6zghk%2FLm8juoXNpe%2FY5%2FE4vbKornKfqnj27qC7BCJdR0n5bAXgD6C68ZEqrnYQGAtov%2BUp5T1y9%2B33z1DownGt%2BSK7biI%2FoBbpm0Ft7v2Z2C%2C1; _em_c3=0; _em_vt=33af8490-f453-4947-b208-ff512ce399eb-1723ab288df-d4bbf62a; _em_vi=3a74ab6c-0d29-4aa3-bb74-1f091da3bae6-1723ab288df-3571ef6e; _em_lt=1590122678494; _em_ft=1590122678494; _em_pc=1; __gads=ID=90c8f90e1900c4ed:T=1590122678:S=ALNI_MaPztKsGbdbK0ijqBX6BnKPE1jfqQ',
      'TE': 'Trailers',
      'Content-Type': 'application/json',
      'Cookie': 'TADCID=xb4pR5DEee-c1F5zABQCjnFE8vTET66GHuEzPi7KfV2dQtLPg4iCvJ_Z66_QKHsAgATqc99Prgq_r5ckaJKuAmvI4B6vXTGf8vE; TAUnique=%1%enc%3AiyVYLMthAw6AwVmIfRXwAx40%2FJkRrjfstBSt4XtnG3Q%3D; TART=%1%enc%3AgMFZiH0V8APR6tPUWRYf72MQLWwsHS2iRSguGQHboQqLZt8SsbUeZ%2B%2BfEVhiGUCJNox8JbUSTxk%3D; TASSK=enc%3AAPL%2B0M4UrH8xAwwBFqSwk3Xm8%2Bm%2FO3pBnORXw9BvAFm%2F0MCL0uteq3wZtROpoqKnu5fn2ILk5pKoAVN1WNHdfphH1n0zjzDGPV8ZFg95%2FRlsPH9JC2u9oYpnJ3PR1vMnUg%3D%3D; TASession=V2ID.4F557FE1C5DED4F2557BC8DD4FA0DE62*SQ.1*GR.83*TCPAR.55*TBR.57*EXEX.6*ABTR.98*PHTB.49*FS.96*CPU.82*HS.recommended*ES.popularity*DS.5*SAS.popularity*FPS.oldFirst*LF.en*FA.1*DF.0*TRA.false*LD.8522945*EAU._; PAC=AFm7_ckuqvtaOvzKNbuAM8FwGxDPVzdxC8Xew3hsQt98LdMoHg9TZJSeZGCBFKzRUZq9L8SP2TyUsfiRbzjmyXuUaP1DqB7Zcvmo492Zj-RuQbxGUnhqKd16xLZ-YAJxHoL2reHBk380LJ85KqnrT76aglrk8sjCIYAUaOIzYGUoebfxgrO1wY2jkOPpOpmsCG31UaAuj4A9e004edK39Fg%3D; ServerPool=A; PMC=V2*MS.93*MD.20200522*LD.20200522; TATravelInfo=V2*AY.2020*AM.7*AD.29*DY.2020*DM.7*DD.30*A.2*MG.-1*HP.2*FL.3*DSM.1590124328886*RS.1; TAUD=LG-1590124328572-2.1.F.*RDD-2-2020_05_22*HDD-3-2020_07_29.2020_07_30.1; TAReturnTo=%1%%2FHotel_Review-g294197-d8522945-Reviews-or5-Lotte_City_Hotel_Myeongdong-Seoul.html; ak_bmsc=D13CE8C991BA5CCA49963A76A1074B03173B488C5B4E00007C72C75E75ACA22C~plZwPH03cd1FQUh0P1Kzpye/K53TxerLxayVza6TNaxZdW9YaCMbln1cx7uoOeZ4kc0HnTkOJ8Oa1+7IWEdobHCDHrDipZZx8aPCqSSp91LHTN4aYDxjw6imy3RAJEj3G/peBm/FHVJvdpj1zHeu8AlWGvNOmgWkZz36cdhHpg0xtN6n0RaTs/SwO5Vr0ZCivczGEqNE1cg+GQnq4C9fSjE1kvtQJnDD9OGZ/N35sg004=; __vt=VnYX5Mfd2RVaCvPRABQCq4R_VSrMTACwWFvfTfL3vw17zUWC2TNQxSWvkoQNOl_9AkPcPxGyo4TYnzGR9ljCE_z_kCW-04K3iGGhUDQ5UotkYH1aw3ehlkXb5Efm4WYLFpvYeDUl22ADbb_IHjYNgF7kag'
    }

    
    error_count = 0
    
    while True:
        try:
            response = requests.request("POST", GRAPHQL_BATCHED_URL, headers=headers, data = payload)
            result = response.json()
            return result
        except:
            time.sleep(3)
            i += 1
            if error_count > 3:
                print(location_id, response.text)
                return False
            continue
            
